services:
  primary:
    image: postgres:16-alpine
    container_name: pg-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: myapp
    command:
      - postgres
      - -c
      - wal_level=replica
      - -c
      - max_wal_senders=3
      - -c
      - max_replication_slots=3
      - -c
      - hot_standby=on
    ports:
      - "5440:5432"
    volumes:
      - primary_data:/var/lib/postgresql/data
      - ./init-primary.sh:/docker-entrypoint-initdb.d/init-primary.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ha-network

  replica:
    image: postgres:16-alpine
    container_name: pg-replica
    depends_on:
      primary:
        condition: service_healthy
    environment:
      PGPASSWORD: replicator123
      PGDATA: /var/lib/postgresql/data
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for primary
        until pg_isready -h primary -U postgres; do sleep 1; done
        sleep 3

        # Clean data directory
        rm -rf /var/lib/postgresql/data/*

        # Backup from primary
        pg_basebackup -h primary -D /var/lib/postgresql/data -U replicator -Fp -Xs -P -R

        # Fix permissions - change ownership to postgres user
        chown -R postgres:postgres /var/lib/postgresql/data
        chmod 700 /var/lib/postgresql/data

        # Start postgres as postgres user
        exec su-exec postgres postgres
    ports:
      - "5441:5432"
    volumes:
      - replica_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - ha-network

  pgpool:
    image: pgpool/pgpool:latest
    platform: linux/amd64
    container_name: pgpool
    depends_on:
      primary:
        condition: service_healthy
      replica:
        condition: service_healthy
    environment:
      PGPOOL_PARAMS_BACKEND_HOSTNAME0: primary
      PGPOOL_PARAMS_BACKEND_PORT0: 5432
      PGPOOL_PARAMS_BACKEND_WEIGHT0: 1
      PGPOOL_PARAMS_BACKEND_FLAG0: ALWAYS_PRIMARY
      PGPOOL_PARAMS_BACKEND_HOSTNAME1: replica
      PGPOOL_PARAMS_BACKEND_PORT1: 5432
      PGPOOL_PARAMS_BACKEND_WEIGHT1: 1
      PGPOOL_PARAMS_BACKEND_FLAG1: DISALLOW_TO_FAILOVER
      PGPOOL_PARAMS_STATEMENT_LEVEL_LOAD_BALANCE: "on"
      PGPOOL_PARAMS_LISTEN_ADDRESSES: "*"
      PGPOOL_PARAMS_PORT: 9999
      PGPOOL_PARAMS_LOAD_BALANCE_MODE: "on"
      PGPOOL_PARAMS_AUTO_FAILBACK: "on"
      PGPOOL_PARAMS_HEALTH_CHECK_PERIOD: 10
      PGPOOL_PARAMS_HEALTH_CHECK_USER: postgres
      PGPOOL_PARAMS_HEALTH_CHECK_PASSWORD: postgres
      PGPOOL_PARAMS_ENABLE_POOL_HBA: "off"
      PGPOOL_PARAMS_ALLOW_CLEAR_TEXT_FRONTEND_AUTH: "on"
    ports:
      - "5442:9999"
    networks:
      - ha-network

volumes:
  primary_data:
  replica_data:

networks:
  ha-network:
    driver: bridge
